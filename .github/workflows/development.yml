name: Development Checks

on:
  push:
    branches-ignore: [ main ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ===== CODE QUALITY CHECKS =====
  lint:
    runs-on: ubuntu-latest
    name: ðŸ” Code Quality
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install linting tools
      run: |
        pip install flake8 black isort mypy
        
    - name: ðŸ” Lint API code
      run: |
        cd api
        echo "ðŸ” Running flake8 on API..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
        echo "ðŸŽ¨ Checking code formatting with black..."
        black --check --diff . || true
        
        echo "ðŸ“¦ Checking import sorting with isort..."
        isort --check-only --diff . || true
        
    - name: ðŸ” Lint Streamlit code
      run: |
        cd streamlit
        echo "ðŸ” Running flake8 on Streamlit..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
        echo "ðŸŽ¨ Checking code formatting with black..."
        black --check --diff . || true

  # ===== SECURITY CHECKS =====
  security:
    runs-on: ubuntu-latest
    name: ðŸ”’ Security Scan
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ”’ Install security tools
      run: |
        pip install bandit safety
        
    - name: ðŸ”’ Run security checks
      run: |
        echo "ðŸ”’ Running bandit security checks..."
        bandit -r . -f json || true
        
        echo "ðŸ”’ Checking for known vulnerabilities..."
        cd api && safety check --json || true
        cd ../streamlit && safety check --json || true

  # ===== DEPENDENCY CHECKS =====
  dependencies:
    runs-on: ubuntu-latest
    name: ðŸ“¦ Dependency Analysis
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Check API dependencies
      run: |
        cd api
        echo "ðŸ“¦ Installing API dependencies..."
        pip install -r requirements.txt
        
        echo "ðŸ“‹ Listing installed packages..."
        pip list
        
        echo "ðŸ” Checking for dependency conflicts..."
        pip check || true
        
    - name: ðŸ“¦ Check Streamlit dependencies
      run: |
        cd streamlit
        echo "ðŸ“¦ Installing Streamlit dependencies..."
        pip install -r requirements.txt
        
        echo "ðŸ“‹ Listing installed packages..."
        pip list
        
        echo "ðŸ” Checking for dependency conflicts..."
        pip check || true

  # ===== PERFORMANCE TESTS =====
  performance:
    runs-on: ubuntu-latest
    name: âš¡ Performance Tests
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd api
        pip install -r requirements.txt
        pip install pytest pytest-benchmark
        
    - name: âš¡ Run performance tests
      run: |
        cd api
        # Create a simple performance test
        cat > test_performance.py << 'EOF'
        import pytest
        import time
        from main import app
        from fastapi.testclient import TestClient

        client = TestClient(app)

        def test_health_endpoint_performance():
            """Test health endpoint response time"""
            start_time = time.time()
            response = client.get("/health")
            end_time = time.time()
            
            response_time = end_time - start_time
            assert response_time < 1.0  # Should respond within 1 second
            assert response.status_code == 200

        def test_import_time():
            """Test application import time"""
            start_time = time.time()
            from main import app
            end_time = time.time()
            
            import_time = end_time - start_time
            assert import_time < 5.0  # Should import within 5 seconds
        EOF
        
        echo "âš¡ Running performance tests..."
        python -m pytest test_performance.py -v || true

  # ===== INTEGRATION TESTS =====
  integration:
    runs-on: ubuntu-latest
    name: ðŸ”— Integration Tests
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd api
        pip install -r requirements.txt
        pip install pytest httpx
        
    - name: ðŸ”— Run integration tests
      run: |
        cd api
        # Create integration test
        cat > test_integration.py << 'EOF'
        import pytest
        from fastapi.testclient import TestClient
        from main import app

        client = TestClient(app)

        def test_health_endpoint():
            """Test health endpoint"""
            response = client.get("/health")
            assert response.status_code == 200
            data = response.json()
            assert "status" in data or "ok" in data

        def test_stats_endpoint():
            """Test stats endpoint"""
            response = client.get("/stats")
            # Should return 200 or 503 (if ES unavailable in test)
            assert response.status_code in [200, 503]

        def test_indices_endpoint():
            """Test indices endpoint"""  
            response = client.get("/indices")
            # Should return 200 or 503 (if ES unavailable in test)
            assert response.status_code in [200, 503]

        def test_search_endpoint_structure():
            """Test search endpoint accepts proper request structure"""
            response = client.post("/search", json={"query": "test", "limit": 1})
            # Should return 200 or error due to ES connection, but not 422 (validation error)
            assert response.status_code != 422
        EOF
        
        echo "ðŸ”— Running integration tests..."
        python -m pytest test_integration.py -v || true