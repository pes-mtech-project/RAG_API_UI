name: ğŸš€ Foolproof Deploy (SSM Commands)

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  INSTANCE_ID: i-05cf3774f0646b47d

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy via Direct Commands
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS credentials  
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}  
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ”§ System Setup
      run: |
        echo "ğŸ”§ Step 1: System setup and updates..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["sudo yum update -y","sudo yum install -y python3 python3-pip git curl","sudo mkdir -p /home/ec2-user/finbert-news-rag-app","sudo chown ec2-user:ec2-user /home/ec2-user/finbert-news-rag-app","echo \"System setup completed\""]' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "System setup Command ID: $COMMAND_ID"
        
        # Wait for command to complete
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        # Get output
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: ğŸ“¥ Code Deployment
      run: |
        echo "ğŸ“¥ Step 2: Code deployment..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["cd /home/ec2-user/finbert-news-rag-app","if [ -d .git ]; then sudo -u ec2-user git pull origin main; else sudo -u ec2-user git clone https://github.com/pes-mtech-project/RAG_API_UI.git .; fi","echo \"Code deployment completed\""]' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Code deployment Command ID: $COMMAND_ID"
        
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: ğŸ”§ Dependencies Installation
      run: |
        echo "ğŸ”§ Step 3: Installing dependencies..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["cd /home/ec2-user/finbert-news-rag-app/api","sudo -u ec2-user python3 -m pip install --user --upgrade pip","sudo -u ec2-user python3 -m pip install --user -r requirements.txt","cd /home/ec2-user/finbert-news-rag-app/streamlit","sudo -u ec2-user python3 -m pip install --user -r requirements.txt","echo \"Dependencies installed\""]' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Dependencies Command ID: $COMMAND_ID"
        
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: âš™ï¸ Service Configuration
      run: |
        echo "âš™ï¸ Step 4: Configuring services..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["sudo systemctl stop finbert-api || true","sudo systemctl stop finbert-streamlit || true","sudo tee /etc/systemd/system/finbert-api.service > /dev/null << \"EOF\"\n[Unit]\nDescription=FinBERT API\nAfter=network.target\n\n[Service]\nType=simple\nUser=ec2-user\nWorkingDirectory=/home/ec2-user/finbert-news-rag-app/api\nEnvironment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin\nExecStart=/usr/bin/python3 -m uvicorn main:app --host 0.0.0.0 --port 8000\nRestart=always\nRestartSec=3\n\n[Install]\nWantedBy=multi-user.target\nEOF","sudo tee /etc/systemd/system/finbert-streamlit.service > /dev/null << \"EOF\"\n[Unit]\nDescription=FinBERT Streamlit\nAfter=network.target\n\n[Service]\nType=simple\nUser=ec2-user\nWorkingDirectory=/home/ec2-user/finbert-news-rag-app/streamlit\nEnvironment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin\nExecStart=/home/ec2-user/.local/bin/streamlit run app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true\nRestart=always\nRestartSec=3\n\n[Install]\nWantedBy=multi-user.target\nEOF","sudo systemctl daemon-reload","echo \"Services configured\""]' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Service config Command ID: $COMMAND_ID"
        
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: ğŸš€ Start Services  
      run: |
        echo "ğŸš€ Step 5: Starting services..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["sudo systemctl enable finbert-api","sudo systemctl enable finbert-streamlit","sudo systemctl start finbert-api","sudo systemctl start finbert-streamlit","sleep 15","sudo systemctl status finbert-api --no-pager","sudo systemctl status finbert-streamlit --no-pager","echo \"Services started\""]' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Service start Command ID: $COMMAND_ID"
        
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Step 6: Health verification..."
        
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "Instance IP: $INSTANCE_IP"
        
        # Health check with retries
        for i in {1..10}; do
          echo "Health check attempt $i/10..."
          
          if curl -f -m 10 "http://$INSTANCE_IP:8000/health" > /dev/null 2>&1; then
            echo "âœ… API is healthy!"
            API_HEALTHY=true
            break
          else
            echo "â³ API not ready yet, waiting..."
            sleep 15
          fi
        done
        
        for i in {1..10}; do
          echo "Streamlit check attempt $i/10..."
          
          if curl -f -m 10 "http://$INSTANCE_IP:8501" > /dev/null 2>&1; then
            echo "âœ… Streamlit is healthy!"
            STREAMLIT_HEALTHY=true
            break
          else
            echo "â³ Streamlit not ready yet, waiting..."
            sleep 15
          fi
        done

    - name: ğŸ‰ Deployment Complete
      run: |
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo ""
        echo "ğŸ‰ FinBERT News RAG App Deployed Successfully!"
        echo "=============================================="
        echo ""
        echo "ğŸ”— Access your application:"
        echo "   ğŸ“Š Streamlit UI: http://$INSTANCE_IP:8501"
        echo "   ğŸ”Œ API Docs: http://$INSTANCE_IP:8000/docs"
        echo "   â¤ï¸  Health Check: http://$INSTANCE_IP:8000/health"
        echo ""
        echo "ğŸ¯ Your FinBERT News RAG application is now live!"