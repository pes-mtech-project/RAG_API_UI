name: ğŸ¯ Simple Deploy (No SSH Issues)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  INSTANCE_ID: i-05cf3774f0646b47d

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy via Systems Manager
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸš€ Deploy via AWS Systems Manager
      run: |
        # Create the deployment command
        DEPLOY_COMMANDS='[
          "sudo yum update -y",
          "sudo yum install -y python3 python3-pip git",
          "sudo mkdir -p /home/ec2-user/finbert-news-rag-app",
          "sudo chown ec2-user:ec2-user /home/ec2-user/finbert-news-rag-app",
          "cd /home/ec2-user/finbert-news-rag-app",
          "if [ -d .git ]; then git pull origin main; else git clone https://github.com/pes-mtech-project/RAG_API_UI.git .; fi",
          "cd api && python3 -m pip install --user --upgrade pip",
          "python3 -m pip install --user -r requirements.txt",
          "cd ../streamlit && python3 -m pip install --user -r requirements.txt",
          "cd .."
        ]'
        
        echo "Sending deployment commands..."
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters "commands=$DEPLOY_COMMANDS" \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        
        # Wait for command to complete
        echo "Waiting for deployment to complete..."
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        # Get command result
        echo "Getting deployment results..."
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: ğŸ”§ Setup Services via Systems Manager
      run: |
        # Create systemd services
        SERVICE_COMMANDS='[
          "sudo tee /etc/systemd/system/finbert-api.service > /dev/null <<EOL\n[Unit]\nDescription=FinBERT API\nAfter=network.target\n\n[Service]\nType=simple\nUser=ec2-user\nWorkingDirectory=/home/ec2-user/finbert-news-rag-app/api\nEnvironment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin\nExecStart=/usr/bin/python3 -m uvicorn main:app --host 0.0.0.0 --port 8000\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOL",
          "sudo tee /etc/systemd/system/finbert-streamlit.service > /dev/null <<EOL\n[Unit]\nDescription=FinBERT Streamlit\nAfter=network.target\n\n[Service]\nType=simple\nUser=ec2-user\nWorkingDirectory=/home/ec2-user/finbert-news-rag-app/streamlit\nEnvironment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin\nExecStart=/home/ec2-user/.local/bin/streamlit run app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOL",
          "sudo systemctl daemon-reload",
          "sudo systemctl stop finbert-api || true",
          "sudo systemctl stop finbert-streamlit || true", 
          "sudo systemctl enable finbert-api",
          "sudo systemctl enable finbert-streamlit",
          "sudo systemctl start finbert-api",
          "sudo systemctl start finbert-streamlit",
          "sleep 10",
          "sudo systemctl status finbert-api --no-pager",
          "sudo systemctl status finbert-streamlit --no-pager"
        ]'
        
        echo "Setting up services..."
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters "commands=$SERVICE_COMMANDS" \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Service setup Command ID: $COMMAND_ID"
        
        # Wait for service setup to complete
        aws ssm wait command-executed \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }}
        
        # Get service setup result
        aws ssm get-command-invocation \
          --command-id $COMMAND_ID \
          --instance-id ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'StandardOutputContent' \
          --output text

    - name: ğŸ¥ Health Check
      run: |
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "Instance IP: $INSTANCE_IP"
        
        # Wait a bit for services to fully start
        sleep 30
        
        # Health check with retries
        for i in {1..5}; do
          echo "Health check attempt $i/5..."
          
          if curl -f -m 10 "http://$INSTANCE_IP:8000/health" > /dev/null 2>&1; then
            echo "âœ… API is healthy!"
            API_HEALTHY=true
            break
          else
            echo "â³ API not ready yet, waiting..."
            sleep 15
          fi
        done
        
        for i in {1..5}; do
          echo "Streamlit check attempt $i/5..."
          
          if curl -f -m 10 "http://$INSTANCE_IP:8501" > /dev/null 2>&1; then
            echo "âœ… Streamlit is healthy!"
            STREAMLIT_HEALTHY=true
            break
          else
            echo "â³ Streamlit not ready yet, waiting..."
            sleep 15
          fi
        done

    - name: ğŸ‰ Success Summary
      run: |
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo ""
        echo "ğŸš€ FinBERT News RAG App Deployed Successfully!"
        echo "=============================================="
        echo ""
        echo "ğŸ”— Access your application:"
        echo "   ğŸ“Š Streamlit UI: http://$INSTANCE_IP:8501"
        echo "   ğŸ”Œ API Docs: http://$INSTANCE_IP:8000/docs"
        echo "   â¤ï¸  Health Check: http://$INSTANCE_IP:8000/health"
        echo ""
        echo "ğŸ¯ Your FinBERT News RAG application is now live!"
        echo "Ready to answer financial questions with AI-powered insights!"