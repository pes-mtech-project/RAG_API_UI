name: Build Base Image

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
    paths:
      - 'api/requirements.txt'
      - 'docker/Dockerfile.api'
  schedule:
    # Rebuild base image weekly (Sundays at 2 AM)
    - cron: '0 2 * * 0'

env:
  REGISTRY: ghcr.io
  BASE_IMAGE_NAME: pes-mtech-project/finbert-news-rag-app/finbert-base

permissions:
  contents: read
  packages: write

jobs:
  build-base:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ï¿½ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: ï¿½ðŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ·ï¸ Extract metadata for base image
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=base-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push base image
      env:
        REGISTRY: ghcr.io
        IMAGE_NAME: ${{ github.repository }}/finbert-base
      run: |
        # Build and push base image from Dockerfile.base (base stage)
        docker buildx build \
          --file docker/Dockerfile.base \
          --target base \
          --tag $REGISTRY/$BASE_IMAGE_NAME:$GITHUB_REF_NAME \
          --tag $REGISTRY/$BASE_IMAGE_NAME:latest \
          --platform linux/amd64 \
          --cache-from type=gha \
          --push \
          .

    - name: ï¿½ Make container package public
      run: |
        # Make the base image package public for ECS access
        gh api --method PATCH /orgs/pes-mtech-project/packages/container/finbert-news-rag-app%2Ffinbert-base \
          --field visibility=public || \
        echo "âš ï¸ Package might already be public or permissions may be needed"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ï¿½ðŸ“ Summary
      run: |
        echo "## ðŸŽ¯ Base Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Image Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ env.BASE_IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Tags**: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ Performance Impact" >> $GITHUB_STEP_SUMMARY
        echo "- **Contains**: Python 3.9 + ML libraries (torch, transformers, etc.)" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: ~5-8 minutes (one-time cost)" >> $GITHUB_STEP_SUMMARY
        echo "- **Future Builds**: ~30-60 seconds (code layer only)" >> $GITHUB_STEP_SUMMARY
        echo "- **Cache Benefit**: 85-90% build time reduction" >> $GITHUB_STEP_SUMMARY