# ğŸš€ CI/CD DEPLOYMENT MAIN WORKFLOW
name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
  
jobs:
  # ===== TESTING STAGE =====
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Run Tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Install API dependencies
      run: |
        cd api
        pip install -r requirements.txt
        
    - name: ğŸ”§ Install Streamlit dependencies  
      run: |
        cd streamlit
        pip install -r requirements.txt
        
    - name: âœ… Test API imports
      run: |
        cd api
        python -c "
        try:
            from main import app
            print('âœ… FastAPI app imports successfully')
        except Exception as e:
            print(f'âŒ FastAPI import failed: {e}')
            exit(1)
        "
        
    - name: âœ… Test Streamlit imports
      run: |
        cd streamlit  
        python -c "
        try:
            import streamlit as st
            import requests
            import pandas as pd
            import plotly
            print('âœ… Streamlit dependencies import successfully')
        except Exception as e:
            print(f'âŒ Streamlit imports failed: {e}')
            exit(1)
        "

  # ===== BUILD STAGE =====
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    name: ğŸ—ï¸ Build Application
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd api && pip install -r requirements.txt
        cd ../streamlit && pip install -r requirements.txt
        
    - name: ğŸ” Validate configuration files
      run: |
        echo "âœ… Checking API configuration..."
        if [ -f "api/main.py" ]; then
          echo "âœ… API main.py exists"
        else
          echo "âŒ API main.py missing"
          exit 1
        fi
        
        echo "âœ… Checking Streamlit configuration..."
        if [ -f "streamlit/app.py" ]; then
          echo "âœ… Streamlit app.py exists"  
        else
          echo "âŒ Streamlit app.py missing"
          exit 1
        fi
        
        echo "âœ… Checking requirements files..."
        if [ -f "api/requirements.txt" ] && [ -f "streamlit/requirements.txt" ]; then
          echo "âœ… Requirements files exist"
        else
          echo "âŒ Requirements files missing"
          exit 1
        fi

  # ===== DEPLOYMENT STAGE =====
  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    name: ğŸš€ Deploy to AWS EC2
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        
    - name: ğŸ“¡ Deploy to EC2
      run: |
        # Add EC2 to known hosts
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Starting deployment to EC2..."
        
        # Create application directory if it doesn't exist
        if [ ! -d "/home/ec2-user/finbert-news-rag-app" ]; then
          echo "ğŸ“ Creating application directory..."
          mkdir -p /home/ec2-user/finbert-news-rag-app
          cd /home/ec2-user/finbert-news-rag-app
          
          # Clone the repository
          echo "ğŸ“¥ Cloning repository..."
          git clone https://github.com/pes-mtech-project/RAG_API_UI.git .
        else
          echo "ğŸ“ Application directory exists, updating..."
          cd /home/ec2-user/finbert-news-rag-app
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
        fi
        
        # Install system dependencies if needed
        echo "ğŸ”§ Installing system dependencies..."
        sudo yum update -y
        sudo yum install -y python3-pip git
        
        # Stop existing services
        echo "ğŸ›‘ Stopping existing services..."
        sudo systemctl stop finbert-api || true
        sudo systemctl stop finbert-streamlit || true
        
        # Update API dependencies
        echo "ğŸ”§ Updating API dependencies..."
        cd api
        python3 -m pip install -r requirements.txt --user --upgrade
        
        # Update Streamlit dependencies
        echo "ğŸ”§ Updating Streamlit dependencies..."  
        cd ../streamlit
        python3 -m pip install -r requirements.txt --user --upgrade
        
        # Go back to root
        cd ..
        
        # Setup systemd services
        echo "âš™ï¸ Setting up systemd services..."
        sudo cp finbert-api.service /etc/systemd/system/
        sudo cp finbert-streamlit.service /etc/systemd/system/
        sudo systemctl daemon-reload
        
        # Start services
        echo "â–¶ï¸ Starting services..."
        sudo systemctl start finbert-api
        sudo systemctl start finbert-streamlit
        sudo systemctl enable finbert-api
        sudo systemctl enable finbert-streamlit
        
        # Wait for services to start
        sleep 10
        
        # Health check
        echo "ğŸ¥ Running health checks..."
        if curl -f http://localhost:8000/health > /dev/null 2>&1; then
          echo "âœ… API health check passed"
        else
          echo "âŒ API health check failed"
          sudo systemctl status finbert-api
          exit 1
        fi
        
        if curl -f http://localhost:8501 > /dev/null 2>&1; then
          echo "âœ… Streamlit health check passed"
        else
          echo "âŒ Streamlit health check failed"
          sudo systemctl status finbert-streamlit
          exit 1
        fi
        
        echo "ğŸ‰ Deployment completed successfully!"
        EOF
        
        # Make script executable and run on EC2
        chmod +x deploy.sh
        scp deploy.sh ec2-user@${{ secrets.EC2_HOST }}:/tmp/deploy.sh
        ssh ec2-user@${{ secrets.EC2_HOST }} "bash /tmp/deploy.sh"
        
    - name: ğŸ¥ Post-deployment health check
      run: |
        echo "ğŸ” Running external health checks..."
        
        # Wait for services to be fully ready
        sleep 30
        
        # Check API endpoint
        if curl -f "http://${{ secrets.EC2_HOST }}:8000/health" > /dev/null 2>&1; then
          echo "âœ… External API health check passed"
        else
          echo "âš ï¸ External API health check failed (might be behind ALB)"
        fi
        
        echo "ğŸ‰ Deployment pipeline completed!"

  # ===== NOTIFICATION STAGE =====
  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    name: ğŸ“§ Send Notifications
    
    steps:
    - name: ğŸ“§ Notify deployment status
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ FinBERT RAG App Deployment Status: ${{ job.status }}
          
          ğŸ“Š Details:
          â€¢ Repository: ${{ github.repository }}
          â€¢ Branch: ${{ github.ref }}
          â€¢ Commit: ${{ github.sha }}
          â€¢ Author: ${{ github.actor }}
          
          ğŸ”— Links:
          â€¢ API: http://${{ secrets.EC2_HOST }}:8000/docs
          â€¢ Streamlit: http://${{ secrets.EC2_HOST }}:8501
          â€¢ Repository: https://github.com/${{ github.repository }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # Optional