name: ğŸ¯ Ultimate Deploy (User Data Approach)

on:
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Force instance restart for clean deployment'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  AWS_REGION: ap-south-1
  INSTANCE_ID: i-05cf3774f0646b47d

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy via User Data (Bulletproof)
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS credentials  
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸš€ Deploy via User Data (No SSH Needed!)
      run: |
        echo "ğŸ¯ Creating bulletproof deployment script..."
        
        # Create the deployment script that will run on instance startup
        cat > user-data.sh << 'EOF'
        #!/bin/bash
        exec > >(tee /var/log/deployment.log) 2>&1
        set -e
        
        echo "ğŸš€ Starting bulletproof deployment at $(date)"
        
        # Update system
        yum update -y
        yum install -y python3 python3-pip git curl htop
        
        # Create application directory
        mkdir -p /home/ec2-user/finbert-news-rag-app
        chown ec2-user:ec2-user /home/ec2-user/finbert-news-rag-app
        
        # Switch to ec2-user for application setup
        sudo -u ec2-user bash << 'APPSETUP'
        cd /home/ec2-user/finbert-news-rag-app
        
        # Clone or update repository
        if [ -d ".git" ]; then
            echo "ğŸ“¥ Updating existing repository..."
            git pull origin main
        else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/pes-mtech-project/RAG_API_UI.git .
        fi
        
        # Install API dependencies
        echo "ğŸ”§ Installing API dependencies..."
        cd api
        python3 -m pip install --user --upgrade pip
        python3 -m pip install --user -r requirements.txt
        
        # Install Streamlit dependencies
        echo "ğŸ”§ Installing Streamlit dependencies..."
        cd ../streamlit
        python3 -m pip install --user -r requirements.txt
        
        # Go back to root
        cd /home/ec2-user/finbert-news-rag-app
        APPSETUP
        
        # Create systemd service for API
        cat > /etc/systemd/system/finbert-api.service << 'APISERVICE'
        [Unit]
        Description=FinBERT News RAG API Service
        After=network.target
        StartLimitBurst=3
        StartLimitIntervalSec=60
        
        [Service]
        Type=simple
        User=ec2-user
        WorkingDirectory=/home/ec2-user/finbert-news-rag-app/api
        Environment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin
        Environment=PYTHONPATH=/home/ec2-user/finbert-news-rag-app/api
        ExecStart=/usr/bin/python3 -m uvicorn main:app --host 0.0.0.0 --port 8000
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
        APISERVICE
        
        # Create systemd service for Streamlit
        cat > /etc/systemd/system/finbert-streamlit.service << 'STREAMLITSERVICE'
        [Unit]
        Description=FinBERT News RAG Streamlit Service
        After=network.target
        StartLimitBurst=3
        StartLimitIntervalSec=60
        
        [Service]
        Type=simple
        User=ec2-user
        WorkingDirectory=/home/ec2-user/finbert-news-rag-app/streamlit
        Environment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin
        Environment=PYTHONPATH=/home/ec2-user/finbert-news-rag-app/streamlit
        ExecStart=/home/ec2-user/.local/bin/streamlit run app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true --server.runOnSave false
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        
        [Install]
        WantedBy=multi-user.target
        STREAMLITSERVICE
        
        # Stop any existing services
        systemctl stop finbert-api || true
        systemctl stop finbert-streamlit || true
        
        # Enable and start services
        systemctl daemon-reload
        systemctl enable finbert-api
        systemctl enable finbert-streamlit
        systemctl start finbert-api
        systemctl start finbert-streamlit
        
        # Wait for services to start
        sleep 20
        
        # Health checks
        echo "ğŸ¥ Running health checks..."
        
        for i in {1..10}; do
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… API health check passed"
                break
            else
                echo "â³ API health check attempt $i/10..."
                sleep 10
            fi
        done
        
        for i in {1..10}; do
            if curl -f http://localhost:8501 > /dev/null 2>&1; then
                echo "âœ… Streamlit health check passed"
                break
            else
                echo "â³ Streamlit health check attempt $i/10..."
                sleep 10
            fi
        done
        
        # Log service status
        systemctl status finbert-api --no-pager
        systemctl status finbert-streamlit --no-pager
        
        # Get public IP and log access URLs
        PUBLIC_IP=$(curl -s http://ifconfig.me)
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ”— Access URLs:"
        echo "   ğŸ“Š Streamlit UI: http://$PUBLIC_IP:8501"
        echo "   ğŸ”Œ API Docs: http://$PUBLIC_IP:8000/docs"
        echo "   â¤ï¸  Health Check: http://$PUBLIC_IP:8000/health"
        
        # Create deployment completion marker
        echo "$(date): Deployment completed successfully" > /home/ec2-user/deployment-complete.txt
        chown ec2-user:ec2-user /home/ec2-user/deployment-complete.txt
        
        EOF
        
        # Base64 encode the user data
        USER_DATA_B64=$(base64 -w 0 user-data.sh)
        
        echo "ğŸ“Š Current instance state:"
        aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].State.Name' \
          --output text
        
        if [ "${{ github.event.inputs.force_restart }}" = "true" ]; then
          echo "ğŸ”„ Stopping instance for clean deployment..."
          aws ec2 stop-instances --instance-ids ${{ env.INSTANCE_ID }} --region ${{ env.AWS_REGION }}
          aws ec2 wait instance-stopped --instance-ids ${{ env.INSTANCE_ID }} --region ${{ env.AWS_REGION }}
          echo "âœ… Instance stopped"
          
          echo "ğŸ“ Setting deployment user data..."
          aws ec2 modify-instance-attribute \
            --instance-id ${{ env.INSTANCE_ID }} \
            --user-data "$USER_DATA_B64" \
            --region ${{ env.AWS_REGION }}
          echo "âœ… User data configured"
          
          echo "â–¶ï¸ Starting instance with new deployment..."
          aws ec2 start-instances --instance-ids ${{ env.INSTANCE_ID }} --region ${{ env.AWS_REGION }}
          aws ec2 wait instance-running --instance-ids ${{ env.INSTANCE_ID }} --region ${{ env.AWS_REGION }}
          echo "âœ… Instance is running"
        else
          echo "âš ï¸ Skipping restart - just updating user data for next boot"
          aws ec2 modify-instance-attribute \
            --instance-id ${{ env.INSTANCE_ID }} \
            --user-data "$USER_DATA_B64" \
            --region ${{ env.AWS_REGION }}
        fi

    - name: â³ Wait for Deployment
      if: github.event.inputs.force_restart == 'true'
      run: |
        echo "â³ Waiting for deployment to complete (this may take 5-10 minutes)..."
        
        # Get instance IP
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "ğŸŒ Instance IP: $INSTANCE_IP"
        
        # Wait for deployment to complete
        echo "ğŸ” Monitoring deployment progress..."
        
        for i in {1..30}; do
          echo "â³ Checking deployment progress... ($i/30)"
          
          # Check if both services are healthy
          API_HEALTHY=false
          STREAMLIT_HEALTHY=false
          
          if curl -f -m 10 "http://$INSTANCE_IP:8000/health" > /dev/null 2>&1; then
            API_HEALTHY=true
            echo "âœ… API is healthy!"
          fi
          
          if curl -f -m 10 "http://$INSTANCE_IP:8501" > /dev/null 2>&1; then
            STREAMLIT_HEALTHY=true
            echo "âœ… Streamlit is healthy!"
          fi
          
          if [ "$API_HEALTHY" = true ] && [ "$STREAMLIT_HEALTHY" = true ]; then
            echo "ğŸ‰ Both services are healthy! Deployment successful!"
            break
          fi
          
          if [ $i -eq 30 ]; then
            echo "âš ï¸ Deployment is taking longer than expected, but may still be in progress"
            echo "ğŸ“‹ You can check manually at: http://$INSTANCE_IP:8501"
          fi
          
          sleep 20
        done

    - name: ğŸ‰ Success Summary
      run: |
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids ${{ env.INSTANCE_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo ""
        echo "ğŸš€ FinBERT News RAG App Deployed Successfully!"
        echo "=============================================="
        echo ""
        echo "ğŸ”— Access your application:"
        echo "   ğŸ“Š Streamlit UI: http://$INSTANCE_IP:8501"
        echo "   ğŸ”Œ API Docs: http://$INSTANCE_IP:8000/docs"
        echo "   â¤ï¸  Health Check: http://$INSTANCE_IP:8000/health"
        echo ""
        echo "ğŸ¯ Your FinBERT News RAG application is now live!"
        echo "ğŸ”„ Services will auto-start on boot and auto-restart on failure"
        echo ""
        echo "ğŸ“Š To check logs if needed:"
        echo "   API Logs: sudo journalctl -u finbert-api -f"
        echo "   Streamlit Logs: sudo journalctl -u finbert-streamlit -f"